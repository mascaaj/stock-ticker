
<h1>Stocks</h1>

<div id="stocks">
  <table class="table table-striped table-hover">
    <thead class="thead-dark">
      <tr>
        <th scope="col">Ticker</th>
        <th scope="col">Company Name</th>
        <th scope="col">Current Price</th>
        <th scope="col">Previous Close</th>
        <th scope="col">Market Cap (000's)</th>
      </tr>
    </thead>
    <tbody>
      <% @stocks.each do |stock| %>
        <%if stock.user_id == current_user.id%>

          <% require 'finnhub_ruby' %>
          <% finhub_key = ENV['FINHUB_API_KEY'] %>
          <% FinnhubRuby.configure do |config|%>
            <%config.api_key['api_key'] = finhub_key.to_str%>
          <%end %>
        
          <% finnhub_client = FinnhubRuby::DefaultApi.new %>
          <%if stock.ticker == ""%>
              <%= @profile.ticker = "N/A"%>
              <%= @profile.name = "N/A"%>
              <%= @rtprice.c = "N/A"%>
              <%= @rtprice.pc = "N/A"%>
              <%= @profile.market_capitalization = "N/A"%>
          <%elsif stock.ticker %>
            <%@rtprice = finnhub_client.quote(stock.ticker)%>
            <%@profile = finnhub_client.company_profile2({symbol: stock.ticker})%>
            <%if finnhub_client.symbol_search(stock.ticker).count == 0%>
              <%= @profile.ticker = "N/A"%>
              <%= @profile.name = "N/A"%>
              <%= @rtprice.c = "N/A"%>
              <%= @rtprice.pc = "N/A"%>
              <%= @profile.market_capitalization = "N/A"%>
            <%end%>
          <%end%>
        <tr>
          <td><%= @profile.ticker%></td>
          <td><%= link_to @profile.name, stock %></td>
          <td>$ <%= number_with_precision(@rtprice.c, :precision => 2, :delimiter =>',') %></td>
          <td>$ <%= number_with_precision(@rtprice.pc, :precision => 2, :delimiter =>',') %></td>
          <td>$ <%= number_with_precision(@profile.market_capitalization, :precision => 0, :delimiter =>',') %></td>
          <td><center><%= link_to 'Edit', edit_stock_path(stock) %></center></td>
          <td><center><%= link_to 'Delete', stock,
          method: :delete, data: {confirm: "Are you sure?"}, class: 'btn btn-danger'%></center></td>
        </tr>
        <%end%>
      <%end%>
    </tbody>
  </table>
</div>

<%= link_to "New stock", new_stock_path %>
